---
title: "ddc.vimå°å…¥æ™‚ã«è©°ã¾ã£ãŸã¨ã“ã‚ãƒ¡ãƒ¢ï¼ˆLSPï¼‰"
emoji: "ğŸ–¤"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["vim", "neovim", "ddc"]
published: true
---

## ã¯ã˜ã‚ã«

nvim-lspã«ä½•åº¦ã‚‚æ‰‹ã‚’å‡ºãã†ã¨ã—ã¦ã¯ã©ã“ã‹ã§è©°ã¾ã£ã¦coc.nvimã«å¸°ã£ã¦ãã¦ã„ã‚‹ã®ã§ã™ãŒã€é—‡ã®åŠ›ã«èˆˆå‘³ãŒå‡ºã¦ã¾ãŸnvim-lspã«æŒ‘æˆ¦ã—ã¦ã„ã‚‹airRnotã§ã™ã€‚ä»Šå›ã€ddc.vimã®å°å…¥æ™‚ã«LSPã¨ã®é€£æºéƒ¨åˆ†ã§è‰²ã€…ã¨è©°ã¾ã£ãŸã®ã§ãã®ãƒã‚¤ãƒ³ãƒˆã«ã¤ã„ã¦æ›¸ã„ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚

## ç’°å¢ƒ

neovimã¯v0.10.0ã§ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒãƒãƒ¼ã‚¸ãƒ£ã¯lazy.nvimã§ã™ã€‚LSPã®è¨­å®šã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚
:::details é•·ã„ã®ã§çœç•¥

```lua
return {
    {
        "williamboman/mason.nvim",
        build = ":MasonUpdate",
        event = { "BufReadPre", "BufNewFile" },
        opts = {},
    },
    {
        "williamboman/mason-lspconfig.nvim",
        dependencies = {
            "neovim/nvim-lspconfig",
            "creativenull/efmls-configs-nvim",
            "Shougo/ddc-source-lsp",
            "uga-rosa/ddc-source-lsp-setup",
        },
        event = { "BufReadPre", "BufNewFile" },
        config = function()
            local lspconfig = require "lspconfig"
            require("ddc_source_lsp_setup").setup()
            local capabilities = require("ddc_source_lsp").make_client_capabilities()
            require("mason-lspconfig").setup_handlers {
                function(server_name)
                    lspconfig[server_name].setup {
                        capabilities = capabilities,
                    }
                end,
                ["lua_ls"] = function()
                    lspconfig.lua_ls.setup {
                        capabilities = capabilities,
                        settings = {
                            Lua = {
                                diagnostics = {
                                    globals = { "vim" },
                                },
                                workspace = {
                                    checkThirdParty = false,
                                },
                                format = {
                                    enable = false,
                                },
                            },
                        },
                    }
                end,
                ["efm"] = function()
                    local stylua = require "efmls-configs.formatters.stylua"
                    local languages = {
                        lua = { stylua },
                    }
                    lspconfig.efm.setup {
                        capabilities = capabilities,
                        filetypes = vim.tbl_keys(languages),
                        init_options = {
                            documentFormatting = true,
                            documentRangeFormatting = true,
                        },
                        settings = {
                            rootMarkers = { ".git/" },
                            languages = languages,
                        },
                    }
                end,
            }
            local augroup = vim.api.nvim_create_augroup("LspFormatting", {})
            vim.api.nvim_create_autocmd("LspAttach", {
                group = augroup,
                callback = function(ev)
                    vim.keymap.set("n", "<C-k>", "<cmd>lua vim.lsp.buf.hover()<CR>")
                    vim.keymap.set("n", "gf", "<cmd>lua vim.lsp.buf.format({ async = false })<CR>")
                    vim.keymap.set("n", "gr", "<cmd>lua vim.lsp.buf.references()<CR>")
                    vim.keymap.set("n", "gd", "<cmd>lua vim.lsp.buf.definition()<CR>")
                    vim.keymap.set("n", "gD", "<cmd>lua vim.lsp.buf.declaration()<CR>")
                    vim.keymap.set("n", "gi", "<cmd>lua vim.lsp.buf.implementation()<CR>")
                    vim.keymap.set("n", "gt", "<cmd>lua vim.lsp.buf.type_definition()<CR>")
                    vim.keymap.set("n", "gn", "<cmd>lua vim.lsp.buf.rename()<CR>")
                    vim.keymap.set("n", "<Leader>.", "<cmd>lua vim.lsp.buf.code_action()<CR>")
                    vim.keymap.set("n", "ge", "<cmd>lua vim.diagnostic.open_float()<CR>")
                    vim.keymap.set("n", "g]", "<cmd>lua vim.diagnostic.goto_next()<CR>")
                    vim.keymap.set("n", "g[", "<cmd>lua vim.diagnostic.goto_prev()<CR>")

                    local client = vim.lsp.get_client_by_id(ev.data.client_id)
                    if client == nil then
                        return
                    end

                    if client.supports_method "textDocument/formatting" then
                        vim.api.nvim_clear_autocmds { group = augroup, buffer = ev.bufnr }
                        vim.api.nvim_create_autocmd({ "BufWritePre" }, {
                            group = augroup,
                            buffer = ev.bufnr,
                            callback = function()
                                vim.lsp.buf.format { async = false }
                            end,
                        })
                    end
                end,
            })

            vim.lsp.handlers["textDocument/publishDiagnostics"] =
                vim.lsp.with(vim.lsp.diagnostic.on_publish_diagnostics, { virtual_text = false })
        end,
    },
}

```

ã¨ã‚Šã‚ãˆãšluaã®lspã¨ã€efmã‚’é€šã—ã¦styluaã ã‘ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
:::

## è©°ã¾ã‚Šãƒã‚¤ãƒ³ãƒˆ

### `ddc-source-lsp`ã¯ä¸€åº¦åå‰ãŒå¤‰ã‚ã£ã¦ã„ã‚‹

ddcã¨LSPã‚’é€£æºã•ã›ã‚‹ã¨ãã¯`ddc-source-lsp`ã‚’ä½¿ã†ã¨æ€ã„ã¾ã™ãŒã€ã“ã®pluginã¯2023å¹´ã®ç§‹é ƒã¾ã§ã¯`ddc-source-nvim-lsp`ã¨ã„ã†åå‰ã§ã—ãŸã€‚

@[card](https://github.com/Shougo/ddc-source-lsp/issues/51)

ã©ã†ã‚„ã‚‰ã€åå‰ãŒå¤‰ã‚ã£ãŸç†ç”±ã¯

> Because it is not only for `nvim-lsp`.

ã ãã†ã§ã™ã€‚

`ddc-source-lsp`ã«é–¢ã™ã‚‹è¨˜äº‹ã‚’èª­ã‚€ã¨ã€

```lua
vim.fn["ddc#custom#patch_global"]("sources", { "nvim-lsp" })

vim.fn["ddc#custom#patch_global"]("sourceOptions", {
    ["nvim-lsp"] = {
        mark = "lsp",
        forceCompletionPattern = "\\.\\w*|:\\w*|->\\w*",
    },
})

```

ã¨ã„ã†ã‚ˆã†ã«ã€`"nvim-lsp"`ã¨æŒ‡å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‚‹ã®ã¯ã“ã®å½±éŸ¿ã§ã™ã­ã€‚ç¾åœ¨ã¯å˜ã«`"lsp"`ã¨æŒ‡å®šã™ã‚Œã°å¤§ä¸ˆå¤«ã§ã™ã€‚æœ€åˆã¯ã©ã¡ã‚‰ãŒåˆã£ã¦ã„ã‚‹ã®ã‹ã‚ã‹ã‚‰ãšå°‘ã—æˆ¸æƒ‘ã„ã¾ã—ãŸã€‚

ã¡ãªã¿ã«ã€markã«`"[LSP]"`ã¨æŒ‡å®šã—ã¦ã„ã‚‹æ–¹ã‚‚ã„ã‚‹ã®ã§ã™ãŒã€ã“ã‚Œã¯å˜ç´”ã«

![](https://storage.googleapis.com/zenn-user-upload/a9ab707fcffa-20240901.png)

å³å´ã«å‡ºã‚‹æ–‡å­—åˆ—ã‚’æŒ‡å®šã—ã¦ã„ã‚‹ã ã‘ãªã®ã§æ°—ã«ã™ã‚‹å¿…è¦ã¯ãªã„ã§ã™ã€‚

### `<CR>`ã¯è£œå®Œã®ç¢ºå®šã§ã¯ãªã„

`<CR>`ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯è£œå®Œã®ç¢ºå®šã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`<CR>`ã‚’æŠ¼ã—ã¦ã‚‚ãŸã æ”¹è¡Œã•ã‚Œã‚‹ã ã‘ã§ã™ã€‚coc.nvimã¯æ°—ã«ã—ãªãã¦ã‚‚`<CR>`ã§è£œå®Œã—ã¦ãã‚ŒãŸã®ã§æ°—ãŒã¤ãã®ã«çµæ§‹ã¦ã”ãšã‚Šã¾ã—ãŸã€‚

ãŠãã‚‰ããƒ‡ãƒ•ã‚©ãƒ«ãƒˆã ã¨`<C-y>`ãŒç¢ºå®šã§ã™ã€‚ï¼ˆuiãŒpumã®å ´åˆã¯è‡ªåˆ†ã§keymapã‚’æ›¸ã‹ãªã„ã¨ã ã‚ã§ã™ï¼‰

### `E1206: Dictionary required for argument 1`ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹

ã“ã“ãŒä»Šå›ä¸€ç•ªãƒãƒã£ãŸéƒ¨åˆ†ã§ã™ã€‚

è£œå®Œã‚’ç¢ºå®šã—ãŸéš›ã«ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚

```
Error detected while processing function <SNR>73_on_complete_done_after[12]..<SNR>73_get_expand_text:
line   15:
E1206: Dictionary required for argument 1
```

çµè«–ã¨ã—ã¦ã¯ã€`hrsh7th/vim-vsnip-integ`ã‚’ä¾å­˜ã«å…¥ã‚Œã¦ã„ãŸã®ãŒåŸå› ã§ã—ãŸã€‚

vnsipä½¿ã†ã‹ã‚‰ãªã‚“ã¨ãªãintegã®æ–¹ã‚‚å…¥ã‚Œã¦ã„ãŸã®ã§ã™ãŒã€ã“ã‚ŒãŒé–“é•ã„ã§ã—ãŸã€‚ãŸã LSPã¨é€£æºã•ã›ã‚‹ã ã‘ãªã‚‰`hrsh7th/vim-vsnip`ã ã‘ã§ååˆ†ã§ã™ã€‚

### è£œå®Œã—ãŸã‚‚ã®ãŒã™ãã«æ¶ˆæ»…ã™ã‚‹

snippetç³»ã«ãŠã„ã¦ã€è£œå®Œã‚’ç¢ºå®šã—ãŸã‚ã¨ã™ãã«æ¶ˆæ»…ã—ã¦ã—ã¾ã†ã¨ã„ã†æŒ™å‹•ãŒèµ·ãã¦ã„ã¾ã—ãŸã€‚

![](https://storage.googleapis.com/zenn-user-upload/3a3b895ffcc7-20240901.gif)

åŸå› ã¯ã€vim scriptã‚’luaã«æ›¸ãç›´ã—ãŸéš›ã®ãƒŸã‚¹ã«ã‚ã‚Šã¾ã—ãŸã€‚

`ddc-source-lsp`ã®READMEã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚

```vim
call ddc#custom#patch_global('sourceParams', #{
      \   lsp: #{
      \     snippetEngine: denops#callback#register({
      \           body -> vsnip#anonymous(body)
      \     }),
      \     enableResolveItem: v:true,
      \     enableAdditionalTextEdit: v:true,
      \   }
      \ })
```

`body -> vsnip#anonymous(body)`ãŒæ³¢æ‹¬å¼§ã§å›²ã¾ã‚Œã¦ã„ãŸã®ã§ã€luaã«æ›¸ãç›´ã—ãŸéš›ã«ã‚‚æ³¢æ‹¬å¼§ã§å›²ã‚“ã§ã„ã¾ã—ãŸã€‚

```lua
vim.fn["ddc#custom#patch_global"]("sourceParams", {
    lsp = {
        snippetEngine = vim.fn["denops#callback#register"] {
            function(body)
                vim.fn["vsnip#anonymous"](body)
            end,
        },
        enableResolveItem = true,
        enableAdditionalTextEdit = true,
    },
})

```

ã—ã‹ã—ã€luaã®å ´åˆã¯æ³¢æ‹¬å¼§ã¯å¿…è¦ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚

```lua
vim.fn["ddc#custom#patch_global"]("sourceParams", {
    lsp = {
        snippetEngine = vim.fn["denops#callback#register"](function(body)
            vim.fn["vsnip#anonymous"](body)
        end),
        enableResolveItem = true,
        enableAdditionalTextEdit = true,
    },
})

```

ã“ã‚Œã§ã€ç„¡äº‹ã«è£œå®ŒãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

## ãŠã‚ã‚Šã«

è©°ã¾ã£ãŸã¨ãã¯ã€GitHubã§ä»–ã®æ–¹ã®è¨­å®šã‚’æ¼ã‚‹ã®ãŒçµæ§‹åŠ¹æœçš„ã§ã—ãŸã€‚
ã¾ãŸã€é—‡ã®åŠ›ã¯è­˜è€…ã®æ–¹ãŒå¤šãã„ã‚‰ã£ã—ã‚ƒã‚Šã€æœ¬å½“ã«åŠ©ã‹ã‚Šã¾ã—ãŸã€‚
ã—ã‹ã—ã€ã¾ã LSPã¨æœ€ä½é™ã®é€£æºã‚’ã—ãŸã ã‘ãªã®ã§ã€ã“ã‚Œã‹ã‚‰ã‚‚ã£ã¨æ‹¡å¼µã—ã¦ã„ããŸã„ã§ã™ã€‚
